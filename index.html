<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ©Ÿè»Šè·¯ç·šæœ€ä½³åŒ–</title>
  <style>
    /* ========= ä¸»é¡Œè®Šæ•¸ï¼šé è¨­æ·ºè‰²ï¼Œhtml[data-theme="dark"] ç‚ºæ·±è‰² ========= */
    :root{
      --bg:#f8f9fa; --panel:#ffffff; --border:#dee2e6;
      --muted:#6c757d; --text:#212529; --accent:#0d6efd;
      --link:#0d6efd; --tag-bg:#e9f2ff; --tag-fg:#0d6efd;
      --details-bg:#ffffff; --details-border:#dee2e6;
      --ok:#0f9d58; --error:#d93025;
    }
    html[data-theme="dark"]{
      --bg:#0b0f19; --panel:#121826; --border:#273255;
      --muted:#9aa4b2; --text:#eef2ff; --accent:#50b0ff;
      --link:#9ed0ff; --tag-bg:#182235; --tag-fg:#9fb5d1;
      --details-bg:#0f1524; --details-border:#273255;
      --ok:#9cffd1; --error:#ff8b8b;
    }

    /* ========= åŸºæœ¬ä½ˆå±€ ========= */
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px}
    h1{font-weight:700;font-size:22px;margin:0 0 12px}
    p.lead{color:var(--muted);margin:0 0 16px}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;
      box-shadow:0 4px 10px rgb(0 0 0 / 10%);padding:16px;margin:16px 0;}

    /* ========= è¡¨å–® ========= */
    label{font-size:13px;color:var(--muted)}
    /* ä¸å½±éŸ¿ checkbox çš„é€šç”¨è¼¸å…¥å…ƒä»¶æ¨£å¼ */
    input:not([type="checkbox"]), select, button{
      box-sizing:border-box;width:100%;padding:8px 10px;min-height:36px;
      border-radius:8px;border:1px solid var(--border);background:#fff;color:var(--text);
    }
    html[data-theme="dark"] input:not([type="checkbox"]),
    html[data-theme="dark"] select,
    html[data-theme="dark"] button{
      background:#0e1421;color:var(--text);border-color:#283246;
    }
    button{cursor:pointer;background:var(--accent);color:#fff;border:none;font-weight:600}
    button.secondary{background:#e9ecef;color:var(--text);border:1px solid var(--border)}
    html[data-theme="dark"] button.secondary{background:#1d273b;border-color:#2a3551}
    input[type="file"]{padding:8px}

    /* è‡ªé©æ‡‰ç¶²æ ¼ï¼šé¿å…äº’ç›¸é®æ“‹ */
    .row,.row3,.row4{display:grid;gap:12px}
    .row {grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .row3{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .row4{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}

    /* ========= Checkbox å€ï¼ˆä½¿ç”¨ .flex å®¹å™¨ï¼‰ ========= */
    /* æ”¾åœ¨æ¬„ä½å…§ï¼šä¸Šé¢å¯åŠ  <div class="muted small">å…¶ä»–é¸é …</div> */
    .flex{display:flex;align-items:center;gap:16px;min-height:36px;flex-wrap:nowrap}
    .flex .cb{display:inline-flex;align-items:center;gap:6px;white-space:nowrap}
    .flex .cb span{font-size:12px;line-height:1;color:var(--text);transform: translateY(11px);}
    /* checkbox æœ¬é«”ä¸åƒé€šç”¨ input æ¨£å¼ */
    input[type="checkbox"]{width:16px;height:16px;margin:0;padding:0;min-height:0;vertical-align:middle;accent-color:var(--accent)}
    .flex input[type="checkbox"]{transform:translateY(11px);}

    /* ========= å…¶ä»– ========= */
    .muted{color:var(--muted);font-size:13px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .links a{display:inline-block;margin:8px 8px 0 0;color:var(--link);text-decoration:none}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--tag-bg);color:var(--tag-fg);font-size:12px;margin-left:6px}
    details{background:var(--details-bg);border:1px solid var(--details-border);border-radius:12px;padding:10px 12px}
    summary{cursor:pointer}
    .error{color:var(--error)} .ok{color:var(--ok)}
    .grid{display:grid;gap:10px} .colspan2{grid-column:span 2}
    .small{font-size:12px}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .kbd{padding:0 6px;border-radius:6px;background:rgba(0,0,0,.06);border:1px solid var(--border)}
    html[data-theme="dark"] .kbd{background:#0b1221;border-color:#28324e}

    /* ========= å³ä¸Šè§’ä¸»é¡Œåˆ‡æ›ï¼šå–®ä¸€æ–¹å¡Š ========= */
    .theme-switch{position:fixed;top:12px;right:16px;z-index:10}
    .theme-switch button{
      min-height:auto;padding:6px 14px;border-radius:6px;background:var(--panel);
      color:var(--text);border:1px solid var(--border);font-size:14px;font-weight:500;cursor:pointer;
    }
    .theme-switch button:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  </style>

  <!-- PapaParse for CSV parsing -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
</head>
<body>
  <div class="theme-switch" aria-label="ä¸»é¡Œåˆ‡æ›">
    <button id="themeToggle" type="button">æš—è‰²</button>
  </div>
  <div class="wrap">
    <h1>è·‘åº—è·¯ç·šæœ€ä½³åŒ–</h1>
    <div class="card grid">
      <div class="row">
        <div>
          <label>Google Maps API Keyï¼ˆåƒ…å‰ç«¯ä½¿ç”¨ï¼Œå‹™å¿…è¨­å®šç¶²åŸŸé™åˆ¶èˆ‡ API é™åˆ¶ï¼‰</label>
          <input id="apiKey" placeholder="æ ¼å¼ï¼šAIzaSyA-1234567890abcdefgHIJKLMNopqrstu"/>
        </div>
      </div>
      <div class="row">
        <div>
          <label>èµ·é»ï¼ˆä¾‹å¦‚ï¼š7-ELEVEN çµ±å®¢é–€å¸‚ï¼‰</label>
          <input id="origin" placeholder="7-ELEVEN çµ±å®¢é–€å¸‚" /> <!--è‹¥æƒ³æ”¹æˆé è¨­å€¼ï¼Œå¯å°‡ placeholder æ”¹æˆ value-->
        </div>
        <div>
          <label>çµ‚é»ï¼ˆä¾‹å¦‚ï¼š231æ–°åŒ—å¸‚æ–°åº—å€å¯¶èˆˆè·¯49è™Ÿï¼‰</label>
          <input id="destination" placeholder="231æ–°åŒ—å¸‚æ–°åº—å€å¯¶èˆˆè·¯49è™Ÿ" /> <!--è‹¥æƒ³æ”¹æˆé è¨­å€¼ï¼Œå¯å°‡ placeholder æ”¹æˆ value-->
        </div>
      </div>
      <div class="row3">
        <div>
          <label>ç¸½åº—é»æœ€å¤§ç­†æ•¸ï¼ˆRoutes API ä¸Šé™ 23ï¼‰</label>
          <input id="maxApi" type="number" min="1" max="23" value="23" />
        </div>
        <div>
          <label>æ¯æ®µè·¯å¾‘æœ€å¤§ä¸­ç¹¼é»æ•¸ï¼ˆGoogle Maps URL ä¸Šé™ 8ï¼‰</label>
          <input id="maxUrl" type="number" min="1" max="8" value="8" />
        </div>
        <div>
          <label>äº¤é€šå·¥å…·</label>
          <select id="mode">
            <option value="TWO_WHEELER" selected>æ©Ÿè»Š</option>
            <option value="DRIVE">æ±½è»Š</option>
            <option value="BICYCLE">è‡ªè¡Œè»Š</option>
            <option value="WALK">æ­¥è¡Œ</option>
          </select>
        </div>
      </div>
      <div class="row3">
        <div>
          <label>åº—åæ¬„ä½ç´¢å¼•ï¼ˆå¾ 0 èµ·ç®—ï¼Œé è¨­ç‚º 0ï¼‰</label>
          <input id="colName" type="number" min="0" value="0" />
        </div>
        <div>
          <label>åœ°å€æ¬„ä½ç´¢å¼•ï¼ˆå¾ 0 èµ·ç®—ï¼Œé è¨­ç‚º 2ï¼‰</label>
          <input id="colAddr" type="number" min="0" value="2" />
        </div>
        <div class="flex">
          <label class="cb" for="avoidHighways">
            <input id="avoidHighways" type="checkbox" checked />
            <span>é¿é–‹é«˜é€Ÿå…¬è·¯</span>
          </label>
          <label class="cb" for="avoidTolls">
            <input id="avoidTolls" type="checkbox" checked />
            <span>é¿é–‹æ”¶è²»è·¯æ®µ</span>
          </label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>ä¸Šå‚³ .csv åº—é»æª”æ¡ˆï¼ˆç„¡æ¨™é¡Œåˆ—ï¼›é è¨­ç¬¬ 0 æ¬„=åº—åã€ç¬¬ 2 æ¬„=åœ°å€ï¼‰</label>
          <input id="csvFile" type="file" accept=".csv" />
        </div>
        <div class="grid">
          <label>&nbsp;</label>
          <button id="runBtn">é–‹å§‹ç”¢ç”Ÿè·¯ç·š</button>
          <small class="muted">è‹¥æ©Ÿè»Šæ¨¡å¼åœ¨ä½ çš„æ‰€åœ¨å€åŸŸå°šç„¡æ³•æ”¯æ´ï¼Œç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨æ±½è»Šæ¨¡å¼ã€‚</small>
        </div>
      </div>

      <div class="hr"></div>
      <div id="log" class="small mono"></div>
    </div>

    <div class="card">
      <h3>è·¯å¾‘è¼¸å‡º</h3>
      <div class="links" id="outLinks"></div>
    </div>

    <details class="card">
      <summary>èªªæ˜ / æ³¨æ„äº‹é …</summary>
      <ul>
        
        <li>
          æœ¬ç¨‹å¼ä½¿ç”¨ Google Geocoding API å’Œ Routes API ã€‚è©³è«‹è«‹è¦‹
          <a href="https://cloud.google.com/apis?hl=zh-TW" target="_blank">Cloud API | Google Cloud</a>
          <ul>
            <li>API Key éœ€è¨­å®šã€ŒHTTP ä¾†æºé™åˆ¶ï¼ˆç¶²åŸŸï¼‰ã€èˆ‡ã€ŒAPI é™åˆ¶ï¼ˆRoutes APIã€Places APIã€Geocoding APIï¼‰ã€ã€‚</li>
            <li>Routes API æ”¯æ´å–®æ¬¡æœ€å¤š 25 å€‹é»ï¼ˆå«èµ·é»èˆ‡çµ‚é»ï¼‰ï¼Œæ•…æœ€å¤šèƒ½å®‰æ’ 23 å€‹ä¸­ç¹¼é»ã€‚</li>
            <li>Google Maps æ‰‹æ©Ÿç‰ˆ APP æœ€å¤šæ”¯æ´ 8 å€‹åœé é»ï¼Œè·¯å¾‘å·²è‡ªå‹•åˆ†æ®µã€‚</li>
            <li>æ©Ÿè»Šæ¨¡å¼åœ¨éƒ¨åˆ†åœ°å€å°šæœªå…¨é¢é–‹æ”¾ï¼Œè‹¥å‘¼å«å¤±æ•—æœƒè‡ªå‹•å›åˆ°æ±½è»Šæ¨¡å¼ã€‚</li>
          </ul>
        </li>
        
        <li>
          .csv åº—é»æª”æ¡ˆæª”ä½œç‚ºè¼¸å…¥æª”æ¡ˆï¼Œéœ€è¦å°‡ .xlvs åº—é¢æª”æ¡ˆå…ˆè½‰æª”ï¼Œä¸¦åªä¿ç•™éœ€è¦çš„é»ï¼›é è¨­ä¸å­˜åœ¨æ¨™é¡Œåˆ—ï¼Œæ•…è‹¥æ¬„ä½ä½ç½®ä¸åŒï¼Œéœ€è¦èª¿æ•´ç´¢å¼•ã€‚
          <details>
            <summary>ç¯„ä¾‹</summary>
            <img src="csv_example.png" alt="ç¯„ä¾‹åœ–ç‰‡" width="600">
          </details>
        </li>
        
      </ul>
    </details>
    
  </div>

  <script>
    // ---------- å·¥å…· ----------
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function log(msg, cls = "") {
      const el = document.getElementById('log');
      const line = document.createElement('div');
      line.textContent = msg;
      if (cls) line.classList.add(cls);
      el.appendChild(line);
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = (d) => d * Math.PI / 180;
      const dphi = toRad(lat2 - lat1);
      const dlambda = toRad(lon2 - lon1);
      const a = Math.sin(dphi/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dlambda/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function buildMapsUrl(origin, destination, wps) {
      const base = "https://www.google.com/maps/dir/?api=1";
      const params = {
        origin, destination,
        travelmode: "driving",
        avoid: "highways|tolls",
        dirflg: "m", // two-wheeler flag in URL
      };
      if (wps && wps.length) params.waypoints = wps.join("|");
      const enc = Object.entries(params).map(([k,v]) => `${k}=${encodeURIComponent(v)}`).join('&');
      return `${base}&${enc}`;
    }

    // â˜… è®€ CSVï¼šå¤šç·¨ç¢¼è‡ªå‹•åµæ¸¬ï¼ˆé¿å…äº‚ç¢¼ï¼‰
    async function readCsvSmart(file) {
      const buf = await file.arrayBuffer();
      const encodings = ['utf-8', 'big5-hkscs', 'big5', 'cp950', 'utf-16le', 'utf-16be', 'iso-8859-1'];
      let best = { text: null, enc: null, bad: Infinity };

      for (const enc of encodings) {
        try {
          const dec = new TextDecoder(enc, { fatal: false });
          const text = dec.decode(new Uint8Array(buf));
          const bad = (text.match(/\uFFFD/g) || []).length; //   çš„æ•¸é‡
          if (bad < best.bad) best = { text, enc, bad };
          if (bad === 0 && /[\u4E00-\u9FFF]/.test(text)) { // ç„¡æ›¿æ›å­—å…ƒä¸”æœ‰ä¸­æ–‡å­—
            best = { text, enc, bad };
            break;
          }
        } catch {}
      }
      // log(`ğŸ”¤ CSV ç·¨ç¢¼æ¨æ¸¬ï¼š${best.enc ?? 'æœªçŸ¥'}ï¼ˆ =${best.bad}ï¼‰`);
      return best.text ?? new TextDecoder('utf-8').decode(new Uint8Array(buf));
    }

    async function textSearchLatLng(apiKey, query) {
      const url = "https://places.googleapis.com/v1/places:searchText";
      const body = {
        textQuery: `${query} å°ç£`,
        regionCode: "TW",
        maxResultCount: 1,
        languageCode: "zh-TW",
      };
      const headers = {
        "Content-Type": "application/json",
        "X-Goog-Api-Key": apiKey,
        "X-Goog-FieldMask": "places.location"
      };
      const r = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
      if (!r.ok) return null;
      const j = await r.json();
      const places = j.places || [];
      if (!places.length) return null;
      const loc = places[0].location;
      return `${loc.latitude},${loc.longitude}`;
    }

    // â˜… Geocodingï¼šåŠ ä¸Š language èˆ‡ ", å°ç£"
    async function geocodeLatLng(apiKey, query) {
      const url = new URL("https://maps.googleapis.com/maps/api/geocode/json");
      url.searchParams.set('address', `${query} , å°ç£`);
      url.searchParams.set('region', 'tw');
      url.searchParams.set('language', 'zh-TW');
      url.searchParams.set('key', apiKey);
      const r = await fetch(url);
      if (!r.ok) return null;
      const j = await r.json();
      if (!j.results || !j.results.length) return null;
      const loc = j.results[0].geometry.location;
      return `${loc.lat},${loc.lng}`;
    }

    // â˜… Robust geocodeï¼ˆåœ°å€ â†’ TextSearch â†’ åº—å geocodeï¼‰
    async function robustGeocode(apiKey, name, addr) {
      let addrLL = null;
      if (addr && addr.trim()) addrLL = await geocodeLatLng(apiKey, addr);
      if (addrLL) return addrLL;

      const textLL = await textSearchLatLng(apiKey, `${name} ${addr}`.trim());
      if (textLL) return textLL;

      const nameLL = await geocodeLatLng(apiKey, `${name} , å°ç£`);
      if (!nameLL) return null;

      return nameLL;
    }

    // â˜… å»é™¤éè¿‘åº§æ¨™ï¼ˆé¿å…åŒé»ï¼‰
    function dedupeClosePoints(wps, thresholdM = 50) {
      const kept = [];
      for (const [ll, nm] of wps) {
        const [lat, lng] = ll.split(',').map(Number);
        const tooClose = kept.some(([kll]) => {
          const [klat, klng] = kll.split(',').map(Number);
          return haversine(lat, lng, klat, klng) < thresholdM;
        });
        if (tooClose) {
          log(`âš ï¸ èˆ‡æ—¢æœ‰é»è·é›¢ < ${thresholdM}mï¼Œè¦–ç‚ºé‡è¤‡ï¼š${nm}`, 'error');
          continue;
        }
        kept.push([ll, nm]);
      }
      return kept;
    }

    async function computeOptimizedOrder(apiKey, origin, destination, waypoints, travelMode, avoidHighways, avoidTolls) {
      const endpoint = "https://routes.googleapis.com/directions/v2:computeRoutes";
      const body = {
        origin:      { address: `${origin} , å°ç£` },
        destination: { address: `${destination} , å°ç£` },
        intermediates: waypoints.map(([ll]) => {
          const [lat, lng] = ll.split(',').map(Number);
          return { location: { latLng: { latitude: lat, longitude: lng } } };
        }),
        travelMode,
        optimizeWaypointOrder: true,
        routeModifiers: { avoidHighways, avoidTolls },
        languageCode: "zh-TW"
      };
      const headers = {
        "Content-Type": "application/json",
        "X-Goog-Api-Key": apiKey,
        "X-Goog-FieldMask": "routes.optimizedIntermediateWaypointIndex"
      };

      if (body.intermediates.length < 2) {
        log('â„¹ï¸ ä¸­ç¹¼é»å°‘æ–¼ 2 å€‹ï¼Œç›´æ¥æ¡ç”¨åŸé †åºã€‚');
        return body.intermediates.map((_, i) => i);
      }

      let r = await fetch(endpoint, { method:'POST', headers, body: JSON.stringify(body) });

      // TWO_WHEELER ä¸æ”¯æ´ â†’ fallback åˆ° DRIVE
      if (!r.ok && travelMode === 'TWO_WHEELER') {
        log(`TWO_WHEELER å¤±æ•—ï¼Œå˜—è©¦æ”¹ç”¨ DRIVE...`, 'error');
        body.travelMode = 'DRIVE';
        r = await fetch(endpoint, { method:'POST', headers, body: JSON.stringify(body) });
      }
      if (!r.ok) {
        const t = await r.text();
        throw new Error(`Routes API error: ${t}`);
      }
      const j = await r.json();
      const idx = j.routes?.[0]?.optimizedIntermediateWaypointIndex || [];

      if (!idx.length) {
        // å¾ˆå¯èƒ½æ˜¯åŒé»/éè¿‘ â†’ æç¤ºä¸¦å›åŸé †åº
        log('âš ï¸ Routes API æœªæä¾›æœ€ä½³åŒ–ç´¢å¼•ï¼Œå¤šåŠæ˜¯åº§æ¨™é‡ç–Š/éè¿‘ï¼Œå°‡ç›´æ¥ä½¿ç”¨åŸé †åºã€‚', 'error');
        return body.intermediates.map((_, i) => i);
      }
      // é˜²å‘†ï¼šé•·åº¦ä¸ä¸€è‡´æ™‚ï¼Œä»¥å…©è€…æœ€å°é•·åº¦åˆ‡é½Š
      if (idx.length !== waypoints.length) {
        log(`âš ï¸ å›å‚³ç´¢å¼•æ•¸(${idx.length}) â‰  ä¸­ç¹¼é»æ•¸(${waypoints.length})ï¼Œå°‡å°é½Šæœ€å°é•·åº¦ã€‚`, 'error');
      }
      return idx.slice(0, waypoints.length);
    }

    function splitUrlsAndNames(origin, destination, wpsSorted, maxWpUrl) {
      const urls = [], names = [];
      let start = origin; let i = 0; const n = wpsSorted.length;
      while (i < n) {
        const seg = wpsSorted.slice(i, i + maxWpUrl);
        const end = (i + maxWpUrl < n) ? seg[seg.length - 1][0] : destination;
        const waypointsForUrl = end !== destination ? seg.slice(0, -1).map(([p]) => p) : seg.map(([p]) => p);
        urls.push(buildMapsUrl(start, end, waypointsForUrl));
        names.push(seg.map(([_, nm]) => nm));
        start = end;
        i += maxWpUrl;
      }
      return { urls, names };
    }

    function downloadText(filename, content) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 1000);
    }

    document.getElementById('runBtn').addEventListener('click', async () => {
      const apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) return alert('è«‹å…ˆè²¼ä¸Š API Key');

      const origin = document.getElementById('origin').value.trim();
      const destination = document.getElementById('destination').value.trim();
      const colName = parseInt(document.getElementById('colName').value, 10) || 0;
      const colAddr = parseInt(document.getElementById('colAddr').value, 10) || 2;
      const maxApi = Math.max(1, Math.min(23, parseInt(document.getElementById('maxApi').value, 10) || 23));
      const maxUrl = Math.max(1, Math.min(8, parseInt(document.getElementById('maxUrl').value, 10) || 8));
      const travelMode = document.getElementById('mode').value;
      const avoidHighways = document.getElementById('avoidHighways').checked;
      const avoidTolls = document.getElementById('avoidTolls').checked;

      const file = document.getElementById('csvFile').files[0];
      if (!file) return alert('è«‹å…ˆé¸æ“‡ CSV æª”');

      document.getElementById('log').innerHTML = '';
      document.getElementById('outLinks').innerHTML = '';

      log('ğŸ“¥ è®€å– .csv ...');
      // å¤šç·¨ç¢¼è§£ç¢¼ + PapaParse
      const text = await readCsvSmart(file);
      const rows = Papa.parse(text, {
        skipEmptyLines: 'greedy',
        dynamicTyping: false,
        header: false
      }).data;

      const stores = [];
      for (const r of rows) {
        const nameRaw = (r[colName] ?? '').toString().trim();
        const addr = (r[colAddr] ?? '').toString().trim();
        if (!nameRaw || !addr) continue;
        const name = nameRaw.startsWith('å…¨è¯ç¦åˆ©ä¸­å¿ƒ') ? nameRaw : `å…¨è¯ç¦åˆ©ä¸­å¿ƒ ${nameRaw}åº—`;
        stores.push([name, addr]);
        if (stores.length >= maxApi) break;
      }
      log(`â¡ï¸ è®€åˆ°é–€å¸‚ ${stores.length} ç­†ï¼ˆä¸Šé™ ${maxApi}ï¼‰`);

      if (!stores.length) return alert('CSV å…§å®¹ç‚ºç©ºæˆ–æ¬„ä½ç´¢å¼•è¨­å®šéŒ¯èª¤');

      // é€ç­†å–å¾—åº§æ¨™ï¼ˆç¯€æµé¿å… QPS éé«˜ï¼‰
      log('ğŸ“¡ è§£æåœ°é»åº§æ¨™ï¼ˆGeocoding / Places Text Searchï¼‰...');
      const waypoints = [];
      for (let i = 0; i < stores.length; i++) {
        const [name, addr] = stores[i];
        try {
          const ll = await robustGeocode(apiKey, name, addr);
          if (ll) {
            waypoints.push([ll, name]);
            log(` âœ… ${name} â†’ ${ll}`, 'ok');
          } else {
            log(` âš ï¸ ç„¡æ³•å®šä½ ${name}ï¼Œå·²è·³éã€‚`, 'error');
          }
        } catch (e) {
          log(` âš ï¸ ${name} è§£æå¤±æ•—ï¼š${e.message}`, 'error');
        }
        await sleep(120); // è¼•å¾®ç¯€æµ
      }

      if (!waypoints.length) return alert('æ²’æœ‰å¯ç”¨çš„ä¸­ç¹¼é»ï¼ˆè«‹æª¢æŸ¥ CSV/ç·¨ç¢¼/åœ°å€æ ¼å¼ï¼‰');

      // â˜… å»é‡ï¼Œé¿å…åŒé»é€ æˆæœ€ä½³åŒ–ç©ºå›å‚³
      const wpsUnique = dedupeClosePoints(waypoints, 50);
      if (wpsUnique.length < 2) {
        alert('æœ‰æ•ˆä¸­ç¹¼é»ä¸è¶³ï¼ˆå¤šæ•¸åº§æ¨™é‡ç–Šï¼‰ã€‚è«‹æª¢æŸ¥ CSV å…§å®¹èˆ‡åœ°å€ã€‚');
        return;
      }

      // å‘¼å« Routes API
      log('ğŸ§­ å‘¼å« Routes API ä»¥æœ€ä½³åŒ–ä¸­ç¹¼é»é †åº ...');
      let order = [];
      try {
        order = await computeOptimizedOrder(apiKey, origin, destination, wpsUnique, travelMode, avoidHighways, avoidTolls);
      } catch (e) {
        log(e.message, 'error');
        return alert('Routes API å¤±æ•—ï¼Œè«‹æŸ¥çœ‹ Log');
      }

      if (!order.length) {
        // æ¥µç«¯æƒ…æ³ï¼šä»ç‚ºç©ºï¼Œæœ€å¾Œå†é˜²å‘†ä¸€æ¬¡
        log('âš ï¸ ä»æœªå–å¾—æœ€ä½³åŒ–ç´¢å¼•ï¼Œæ”¹ç”¨åŸé †åºè¼¸å‡ºã€‚', 'error');
        order = wpsUnique.map((_, i) => i);
      }

      // é˜²å‘†å°é½Š
      order = order.slice(0, wpsUnique.length);
      const wpsSorted = order.map(i => wpsUnique[i]);
      const { urls, names } = splitUrlsAndNames(origin, destination, wpsSorted, maxUrl);
      const out = document.getElementById('outLinks');
      out.innerHTML = '';

      // å»ºç«‹æ‰€æœ‰ route çš„è¶…é€£çµ
      urls.forEach((u, idx) => {
        const a = document.createElement('a');
        a.href = u; a.target = '_blank';
        a.textContent = `route ${idx+1}`;
        out.appendChild(a);
        out.appendChild(document.createElement('br'));
      });

      // å»ºç«‹å–®ä¸€åˆä½µå…§å®¹
      const combinedText = urls.map((u, idx) => {
        const nm = names[idx] || [];
        return `route${idx+1}: ${u}\n${nm.join('\n')}`;
      }).join('\n\n');

      // æä¾›å–®ä¸€ .txt ä¸‹è¼‰æŒ‰éˆ•
      const btnAll = document.createElement('button');
      btnAll.className = 'secondary';
      btnAll.style.marginTop = '12px';
      btnAll.textContent = 'ä¸‹è¼‰ routes.txt';
      btnAll.addEventListener('click', () => downloadText('routes.txt', combinedText));
      out.appendChild(btnAll);

      log(`âœ… å…±ç”¢ç”Ÿ ${urls.length} æ¢è·¯ç·šä¸¦æ•´åˆç‚ºå–®ä¸€ routes.txtã€‚`);
            
    });

    // ============ ä¸»é¡Œåˆ‡æ›ï¼ˆå«è¨˜æ†¶ï¼‰ ============
    (function initTheme(){
      const root = document.documentElement;
      const toggleBtn = document.getElementById('themeToggle');

      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = saved || (prefersDark ? 'dark' : 'light');
      applyTheme(theme);

      toggleBtn.addEventListener('click', () => {
        const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        applyTheme(current === 'dark' ? 'light' : 'dark');
      });

      function applyTheme(mode){
        if (mode === 'dark') {
          root.setAttribute('data-theme','dark');
          toggleBtn.textContent = 'æ·ºè‰²';
        } else {
          root.removeAttribute('data-theme'); // default = light
          toggleBtn.textContent = 'æš—è‰²';
        }
        localStorage.setItem('theme', mode);
      }
    })();

  </script>
</body>
</html>


